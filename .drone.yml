kind: pipeline
type: docker
name: default
trigger:
  branch:
    #- dev
    - main
steps:
  - name: build-client
    image: gradle:8.9
    volumes:
      - name: sdk
        path: /drone/src/client/sdk
      - name: gradle-cache
        path: /home/gradle/.gradle
    environment:
      ANDROID_HOME: /drone/src/sdk
    commands:
      - sleep 1000
      - cd client
      - chmod +x gradlew
      - chmod +x updav
      - sleep 1000
      - gradle --version
      - ./gradlew assembleRelease --stacktrace
      - APK_CLOUD=$(find "app/build/outputs/apk/cloud/release" -type f -name "*.apk")
      - APK_LOCAL=$(find "app/build/outputs/apk/local/release" -type f -name "*.apk")
      - ./updav -u http://192.168.8.6:8081 -a dev -p Az*29!#^1Nan -f "APK_CLOUD","APK_LOCAL" -r /ahao/heji/apk

  - name: build_server_push
    image: docker:dind
    volumes:
      - name: docker
        path: /var/run/docker.sock
    environment:
      DOCKER_BUILDKIT: 1
      DOCKER_USER:
        from_secret: DOCKER_USER
      DOCKER_PWD:
        from_secret: DOCKER_PWD
    commands:
      - docker --version
      - cd ./server
      - docker login -u "$DOCKER_USER" -p "$DOCKER_PWD".    # login to docker hub
      - docker buildx create --name aBuildX --use      # Create and use a Buildx builder
      - docker buildx build --platform linux/amd64 -f Dockerfile -t hao88/heji-server:amd64 --push . # Build and push amd64 image
      - docker buildx rm aBuildX  # Remove the Buildx builder

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock
  - name: sdk
    host:
      path: /mnt/user/appdata/drone/tools/android/sdk
  - name: gradle-cache
    host:
      path: /mnt/user/appdata/drone/tools/gradle/cache-heji
